// Compiled by ClojureScript 0.0-2138
goog.provide('lt.objs.deploy');
goog.require('cljs.core');
goog.require('lt.util.cljs');
goog.require('lt.util.js');
goog.require('lt.objs.app');
goog.require('lt.objs.sidebar.command');
goog.require('lt.objs.files');
goog.require('lt.util.js');
goog.require('lt.objs.platform');
goog.require('lt.objs.popup');
goog.require('lt.objs.cache');
goog.require('lt.objs.popup');
goog.require('lt.objs.notifos');
goog.require('lt.objs.notifos');
goog.require('clojure.string');
goog.require('lt.util.cljs');
goog.require('lt.objs.platform');
goog.require('lt.objs.files');
goog.require('lt.objs.app');
goog.require('lt.objs.clients');
goog.require('lt.util.load');
goog.require('clojure.string');
goog.require('lt.object');
goog.require('lt.object');
goog.require('lt.util.load');
goog.require('lt.objs.cache');
goog.require('lt.objs.clients');
goog.require('lt.objs.sidebar.command');
goog.require('fetch.core');
goog.require('fetch.core');
lt.objs.deploy.shell = lt.util.load.node_module.call(null,"shelljs");
lt.objs.deploy.fs = require("fs");
lt.objs.deploy.fs_path = require("path");
lt.objs.deploy.zlib = require("zlib");
lt.objs.deploy.request = lt.util.load.node_module.call(null,"request");
lt.objs.deploy.tar = lt.util.load.node_module.call(null,"tar");
lt.objs.deploy.home_path = lt.objs.files.lt_home.call(null,"");
lt.objs.deploy.get_proxy = require("nw.gui").App.getProxyForURL;
lt.objs.deploy.tar_path = (function tar_path(v){if(cljs.core.truth_(lt.objs.cache.fetch.call(null,new cljs.core.Keyword(null,"edge","edge",1017012527))))
{return [cljs.core.str("http://temp2.kodowa.com.s3.amazonaws.com/playground/releases/"),cljs.core.str(v),cljs.core.str(".tar.gz")].join('');
} else
{return [cljs.core.str("https://d35ac8ww5dfjyg.cloudfront.net/playground/releases/"),cljs.core.str(v),cljs.core.str(".tar.gz")].join('');
}
});
lt.objs.deploy.version_regex = /^\d+\.\d+\.\d+(-.*)?$/;
lt.objs.deploy.get_versions = (function get_versions(){var vstr = new cljs.core.Keyword(null,"content","content",1965434859).cljs$core$IFn$_invoke$arity$1(lt.objs.files.open_sync.call(null,lt.objs.files.lt_home.call(null,"core/version.json")));return cljs.core.js__GT_clj.call(null,JSON.parse(vstr),new cljs.core.Keyword(null,"keywordize-keys","keywordize-keys",4191781672),true);
});
lt.objs.deploy.proxy_QMARK_ = (function proxy_QMARK_(){var p = lt.objs.deploy.get_proxy.call(null,lt.objs.deploy.tar_path.call(null,"0.5.0"));if(lt.util.cljs.str_contains_QMARK_.call(null,p,"PROXY"))
{return cljs.core.second.call(null,clojure.string.split.call(null,p," "));
} else
{return null;
}
});
lt.objs.deploy.version_timeout = ((5 * 60) * 1000);
lt.objs.deploy.version = lt.objs.deploy.get_versions.call(null);
lt.objs.deploy.str__GT_version = (function str__GT_version(s){var vec__7858 = clojure.string.split.call(null,s,".");var major = cljs.core.nth.call(null,vec__7858,0,null);var minor = cljs.core.nth.call(null,vec__7858,1,null);var patch = cljs.core.nth.call(null,vec__7858,2,null);return new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"major","major",1117563179),parseInt(major),new cljs.core.Keyword(null,"minor","minor",1117805351),parseInt(minor),new cljs.core.Keyword(null,"patch","patch",1120342970),parseInt(patch)], null);
});
lt.objs.deploy.compare_versions = (function compare_versions(v1,v2){if(cljs.core._EQ_.call(null,v1,v2))
{return false;
} else
{return !(((new cljs.core.Keyword(null,"major","major",1117563179).cljs$core$IFn$_invoke$arity$1(v2) < new cljs.core.Keyword(null,"major","major",1117563179).cljs$core$IFn$_invoke$arity$1(v1))) || ((cljs.core._EQ_.call(null,new cljs.core.Keyword(null,"major","major",1117563179).cljs$core$IFn$_invoke$arity$1(v2),new cljs.core.Keyword(null,"major","major",1117563179).cljs$core$IFn$_invoke$arity$1(v1))) && ((new cljs.core.Keyword(null,"minor","minor",1117805351).cljs$core$IFn$_invoke$arity$1(v2) < new cljs.core.Keyword(null,"minor","minor",1117805351).cljs$core$IFn$_invoke$arity$1(v1)))) || ((cljs.core._EQ_.call(null,new cljs.core.Keyword(null,"major","major",1117563179).cljs$core$IFn$_invoke$arity$1(v2),new cljs.core.Keyword(null,"major","major",1117563179).cljs$core$IFn$_invoke$arity$1(v1))) && (cljs.core._EQ_.call(null,new cljs.core.Keyword(null,"minor","minor",1117805351).cljs$core$IFn$_invoke$arity$1(v2),new cljs.core.Keyword(null,"minor","minor",1117805351).cljs$core$IFn$_invoke$arity$1(v1))) && ((new cljs.core.Keyword(null,"patch","patch",1120342970).cljs$core$IFn$_invoke$arity$1(v2) < new cljs.core.Keyword(null,"patch","patch",1120342970).cljs$core$IFn$_invoke$arity$1(v1)))));
}
});
lt.objs.deploy.is_newer_QMARK_ = (function is_newer_QMARK_(v1,v2){return lt.objs.deploy.compare_versions.call(null,lt.objs.deploy.str__GT_version.call(null,v1),lt.objs.deploy.str__GT_version.call(null,v2));
});
lt.objs.deploy.exec_path = (function exec_path(){return process.execPath;
});
lt.objs.deploy.mac_resources_path = (function mac_resources_path(p){return lt.objs.deploy.fs_path.resolve(lt.objs.deploy.exec_path.call(null),lt.objs.files.join.call(null,"../../../../../Resources",p));
});
lt.objs.deploy.download_file = (function download_file(from,to,cb){var options = (function (){var obj7864 = {"url":from,"headers":(function (){var obj7866 = {"User-Agent":"Light Table"};return obj7866;
})()};return obj7864;
})();var out = lt.objs.deploy.fs.createWriteStream(to);var temp__4092__auto___7867 = (function (){var or__3408__auto__ = process.env.http_proxy;if(cljs.core.truth_(or__3408__auto__))
{return or__3408__auto__;
} else
{return process.env.https_proxy;
}
})();if(cljs.core.truth_(temp__4092__auto___7867))
{var proxy_7868 = temp__4092__auto___7867;options.proxy = proxy_7868;
} else
{}
return lt.objs.deploy.request.call(null,options,cb).pipe(out);
});
lt.objs.deploy.download_zip = (function download_zip(ver,cb){var n = lt.objs.notifos.working.call(null,[cljs.core.str("Downloading version "),cljs.core.str(ver),cljs.core.str(" ..")].join(''));return lt.objs.deploy.download_file.call(null,lt.objs.deploy.tar_path.call(null,ver),[cljs.core.str(lt.objs.deploy.home_path),cljs.core.str("/tmp.tar.gz")].join(''),(function (e,r,body){lt.objs.notifos.done_working.call(null);
return cb.call(null,e,r,body);
}));
});
lt.objs.deploy.untar = (function untar(from,to,cb){var t = lt.objs.deploy.fs.createReadStream(from);return t.pipe(lt.objs.deploy.zlib.createGunzip()).pipe(lt.objs.deploy.tar.Extract((function (){var obj7872 = {"path":to};return obj7872;
})())).on("end",cb);
});
lt.objs.deploy.move_tmp = (function move_tmp(){var seq__7877_7881 = cljs.core.seq.call(null,lt.objs.files.full_path_ls.call(null,[cljs.core.str(lt.objs.deploy.home_path),cljs.core.str("/tmp/")].join('')));var chunk__7878_7882 = null;var count__7879_7883 = 0;var i__7880_7884 = 0;while(true){
if((i__7880_7884 < count__7879_7883))
{var file_7885 = cljs.core._nth.call(null,chunk__7878_7882,i__7880_7884);lt.objs.deploy.shell.cp("-rf",file_7885,lt.objs.deploy.home_path);
{
var G__7886 = seq__7877_7881;
var G__7887 = chunk__7878_7882;
var G__7888 = count__7879_7883;
var G__7889 = (i__7880_7884 + 1);
seq__7877_7881 = G__7886;
chunk__7878_7882 = G__7887;
count__7879_7883 = G__7888;
i__7880_7884 = G__7889;
continue;
}
} else
{var temp__4092__auto___7890 = cljs.core.seq.call(null,seq__7877_7881);if(temp__4092__auto___7890)
{var seq__7877_7891__$1 = temp__4092__auto___7890;if(cljs.core.chunked_seq_QMARK_.call(null,seq__7877_7891__$1))
{var c__4150__auto___7892 = cljs.core.chunk_first.call(null,seq__7877_7891__$1);{
var G__7893 = cljs.core.chunk_rest.call(null,seq__7877_7891__$1);
var G__7894 = c__4150__auto___7892;
var G__7895 = cljs.core.count.call(null,c__4150__auto___7892);
var G__7896 = 0;
seq__7877_7881 = G__7893;
chunk__7878_7882 = G__7894;
count__7879_7883 = G__7895;
i__7880_7884 = G__7896;
continue;
}
} else
{var file_7897 = cljs.core.first.call(null,seq__7877_7891__$1);lt.objs.deploy.shell.cp("-rf",file_7897,lt.objs.deploy.home_path);
{
var G__7898 = cljs.core.next.call(null,seq__7877_7891__$1);
var G__7899 = null;
var G__7900 = 0;
var G__7901 = 0;
seq__7877_7881 = G__7898;
chunk__7878_7882 = G__7899;
count__7879_7883 = G__7900;
i__7880_7884 = G__7901;
continue;
}
}
} else
{}
}
break;
}
return lt.objs.deploy.shell.rm("-rf",[cljs.core.str(lt.objs.deploy.home_path),cljs.core.str("/tmp*")].join(''));
});
lt.objs.deploy.fetch_and_deploy = (function fetch_and_deploy(ver){return lt.objs.deploy.download_zip.call(null,ver,(function (){lt.objs.notifos.working.call(null,"Extracting update...");
return lt.objs.deploy.untar.call(null,[cljs.core.str(lt.objs.deploy.home_path),cljs.core.str("/tmp.tar.gz")].join(''),[cljs.core.str(lt.objs.deploy.home_path),cljs.core.str("/tmp")].join(''),(function (){lt.objs.deploy.move_tmp.call(null);
lt.objs.notifos.done_working.call(null);
return lt.objs.popup.popup_BANG_.call(null,new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"header","header",4087600639),"Light Table has been updated!",new cljs.core.Keyword(null,"body","body",1016933652),[cljs.core.str("Light Table has been updated to "),cljs.core.str(ver),cljs.core.str("! Just\n                                                        restart to get the latest and greatest.")].join(''),new cljs.core.Keyword(null,"buttons","buttons",1255256819),new cljs.core.PersistentVector(null, 1, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"label","label",1116631654),"ok"], null)], null)], null));
}));
}));
});
lt.objs.deploy.version_url = (function version_url(){if(cljs.core.truth_(lt.objs.cache.fetch.call(null,new cljs.core.Keyword(null,"edge","edge",1017012527))))
{return "http://app.kodowa.com/latest-version/nw-edge";
} else
{return "http://app.kodowa.com/latest-version/nw";
}
});
lt.objs.deploy.should_update_popup = (function should_update_popup(data){return lt.objs.popup.popup_BANG_.call(null,new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"header","header",4087600639),"There's a newer version of Light Table!",new cljs.core.Keyword(null,"body","body",1016933652),[cljs.core.str("Would you like us to download and install version "),cljs.core.str(data),cljs.core.str("?")].join(''),new cljs.core.Keyword(null,"buttons","buttons",1255256819),new cljs.core.PersistentVector(null, 2, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"label","label",1116631654),"Cancel"], null),new cljs.core.PersistentArrayMap(null, 2, [new cljs.core.Keyword(null,"label","label",1116631654),"Download and install",new cljs.core.Keyword(null,"action","action",3885920680),(function (){return lt.objs.deploy.fetch_and_deploy.call(null,data);
})], null)], null)], null));
});
/**
* @param {...*} var_args
*/
lt.objs.deploy.check_version = (function() { 
var check_version__delegate = function (p__7902){var vec__7904 = p__7902;var notify_QMARK_ = cljs.core.nth.call(null,vec__7904,0,null);return fetch.core.xhr.call(null,lt.objs.deploy.version_url.call(null),cljs.core.PersistentArrayMap.EMPTY,(function (data){if(cljs.core.truth_(cljs.core.re_seq.call(null,lt.objs.deploy.version_regex,data)))
{if(cljs.core.truth_((function (){var and__3396__auto__ = cljs.core.not_EQ_.call(null,data,"");if(and__3396__auto__)
{var and__3396__auto____$1 = cljs.core.not_EQ_.call(null,data,new cljs.core.Keyword(null,"version","version",1365512266).cljs$core$IFn$_invoke$arity$1(lt.objs.deploy.version));if(and__3396__auto____$1)
{var and__3396__auto____$2 = lt.objs.deploy.is_newer_QMARK_.call(null,new cljs.core.Keyword(null,"version","version",1365512266).cljs$core$IFn$_invoke$arity$1(lt.objs.deploy.version),data);if(and__3396__auto____$2)
{var or__3408__auto__ = notify_QMARK_;if(cljs.core.truth_(or__3408__auto__))
{return or__3408__auto__;
} else
{return cljs.core.not_EQ_.call(null,localStorage.fetchedVersion,data);
}
} else
{return and__3396__auto____$2;
}
} else
{return and__3396__auto____$1;
}
} else
{return and__3396__auto__;
}
})()))
{localStorage.fetchedVersion = data;
lt.objs.deploy.version = cljs.core.assoc.call(null,lt.objs.deploy.version,new cljs.core.Keyword(null,"version","version",1365512266),data);
return lt.objs.deploy.should_update_popup.call(null,data);
} else
{if(cljs.core.truth_(notify_QMARK_))
{return lt.objs.notifos.set_msg_BANG_.call(null,[cljs.core.str("At latest version: "),cljs.core.str(new cljs.core.Keyword(null,"version","version",1365512266).cljs$core$IFn$_invoke$arity$1(lt.objs.deploy.version))].join(''));
} else
{return null;
}
}
} else
{return null;
}
}));
};
var check_version = function (var_args){
var p__7902 = null;if (arguments.length > 0) {
  p__7902 = cljs.core.array_seq(Array.prototype.slice.call(arguments, 0),0);} 
return check_version__delegate.call(this,p__7902);};
check_version.cljs$lang$maxFixedArity = 0;
check_version.cljs$lang$applyTo = (function (arglist__7905){
var p__7902 = cljs.core.seq(arglist__7905);
return check_version__delegate(p__7902);
});
check_version.cljs$core$IFn$_invoke$arity$variadic = check_version__delegate;
return check_version;
})()
;
lt.objs.deploy.binary_version = (function binary_version(){return (process.versions["node-webkit"]);
});
/**
* @param {...*} var_args
*/
lt.objs.deploy.button = (function() { 
var button__delegate = function (label,p__7906){var vec__7914 = p__7906;var cb = cljs.core.nth.call(null,vec__7914,0,null);var e__4335__auto__ = crate.core.html.call(null,new cljs.core.PersistentVector(null, 2, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.Keyword(null,"div.button.right","div.button.right",629503503),label], null));var seq__7915_7921 = cljs.core.seq.call(null,cljs.core.partition.call(null,2,new cljs.core.PersistentVector(null, 2, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.Keyword(null,"click","click",1108654330),(function (){if(cljs.core.truth_(cb))
{return cb.call(null);
} else
{return null;
}
})], null)));var chunk__7916_7922 = null;var count__7917_7923 = 0;var i__7918_7924 = 0;while(true){
if((i__7918_7924 < count__7917_7923))
{var vec__7919_7925 = cljs.core._nth.call(null,chunk__7916_7922,i__7918_7924);var ev__4336__auto___7926 = cljs.core.nth.call(null,vec__7919_7925,0,null);var func__4337__auto___7927 = cljs.core.nth.call(null,vec__7919_7925,1,null);lt.util.dom.on.call(null,e__4335__auto__,ev__4336__auto___7926,func__4337__auto___7927);
{
var G__7928 = seq__7915_7921;
var G__7929 = chunk__7916_7922;
var G__7930 = count__7917_7923;
var G__7931 = (i__7918_7924 + 1);
seq__7915_7921 = G__7928;
chunk__7916_7922 = G__7929;
count__7917_7923 = G__7930;
i__7918_7924 = G__7931;
continue;
}
} else
{var temp__4092__auto___7932 = cljs.core.seq.call(null,seq__7915_7921);if(temp__4092__auto___7932)
{var seq__7915_7933__$1 = temp__4092__auto___7932;if(cljs.core.chunked_seq_QMARK_.call(null,seq__7915_7933__$1))
{var c__4150__auto___7934 = cljs.core.chunk_first.call(null,seq__7915_7933__$1);{
var G__7935 = cljs.core.chunk_rest.call(null,seq__7915_7933__$1);
var G__7936 = c__4150__auto___7934;
var G__7937 = cljs.core.count.call(null,c__4150__auto___7934);
var G__7938 = 0;
seq__7915_7921 = G__7935;
chunk__7916_7922 = G__7936;
count__7917_7923 = G__7937;
i__7918_7924 = G__7938;
continue;
}
} else
{var vec__7920_7939 = cljs.core.first.call(null,seq__7915_7933__$1);var ev__4336__auto___7940 = cljs.core.nth.call(null,vec__7920_7939,0,null);var func__4337__auto___7941 = cljs.core.nth.call(null,vec__7920_7939,1,null);lt.util.dom.on.call(null,e__4335__auto__,ev__4336__auto___7940,func__4337__auto___7941);
{
var G__7942 = cljs.core.next.call(null,seq__7915_7933__$1);
var G__7943 = null;
var G__7944 = 0;
var G__7945 = 0;
seq__7915_7921 = G__7942;
chunk__7916_7922 = G__7943;
count__7917_7923 = G__7944;
i__7918_7924 = G__7945;
continue;
}
}
} else
{}
}
break;
}
return e__4335__auto__;
};
var button = function (label,var_args){
var p__7906 = null;if (arguments.length > 1) {
  p__7906 = cljs.core.array_seq(Array.prototype.slice.call(arguments, 1),0);} 
return button__delegate.call(this,label,p__7906);};
button.cljs$lang$maxFixedArity = 1;
button.cljs$lang$applyTo = (function (arglist__7946){
var label = cljs.core.first(arglist__7946);
var p__7906 = cljs.core.rest(arglist__7946);
return button__delegate(label,p__7906);
});
button.cljs$core$IFn$_invoke$arity$variadic = button__delegate;
return button;
})()
;
lt.objs.deploy.alert_binary_update = (function alert_binary_update(){return lt.objs.popup.popup_BANG_.call(null,new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"header","header",4087600639),"There's been a binary update!",new cljs.core.Keyword(null,"body","body",1016933652),"There's a new version of the Light Table binary. Clicking below will open the\n                                 Light Table website so you can download the updated version.",new cljs.core.Keyword(null,"buttons","buttons",1255256819),new cljs.core.PersistentVector(null, 1, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.PersistentArrayMap(null, 2, [new cljs.core.Keyword(null,"label","label",1116631654),"Download latest",new cljs.core.Keyword(null,"action","action",3885920680),(function (){require("nw.gui").Shell.openExternal("http://www.lighttable.com");
return lt.objs.popup.remain_open.call(null);
})], null)], null)], null));
});
lt.objs.deploy.check_nw_version = (function check_nw_version(obj){return cljs.core.assoc.call(null,obj,new cljs.core.Keyword(null,"nw-version","nw-version",2002200646),lt.objs.deploy.is_newer_QMARK_.call(null,lt.objs.deploy.binary_version.call(null),new cljs.core.Keyword(null,"nw","nw",1013907771).cljs$core$IFn$_invoke$arity$1(lt.objs.deploy.version)));
});
lt.objs.deploy.notify = (function notify(obj){var map__7948 = obj;var map__7948__$1 = ((cljs.core.seq_QMARK_.call(null,map__7948))?cljs.core.apply.call(null,cljs.core.hash_map,map__7948):map__7948);var nw_version = cljs.core.get.call(null,map__7948__$1,new cljs.core.Keyword(null,"nw-version","nw-version",2002200646));if(cljs.core.truth_(nw_version))
{return lt.objs.deploy.alert_binary_update.call(null);
} else
{if(new cljs.core.Keyword(null,"else","else",1017020587))
{return obj;
} else
{return null;
}
}
});
lt.objs.deploy.check_all = (function check_all(){return lt.objs.deploy.notify.call(null,lt.objs.deploy.check_nw_version.call(null,cljs.core.PersistentArrayMap.EMPTY));
});
lt.objs.deploy.__BEH__check_deploy = (function __BEH__check_deploy(this$){return lt.objs.deploy.check_all.call(null);
});
lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.deploy","check-deploy","lt.objs.deploy/check-deploy",1596260355),new cljs.core.Keyword(null,"reaction","reaction",4441361819),lt.objs.deploy.__BEH__check_deploy,new cljs.core.Keyword(null,"triggers","triggers",2516997421),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"deploy","deploy",3973538905),null], null), null));
lt.objs.deploy.__BEH__check_version = (function __BEH__check_version(this$){var temp__4092__auto___7949 = lt.objs.deploy.proxy_QMARK_.call(null);if(cljs.core.truth_(temp__4092__auto___7949))
{var proxy_7950 = temp__4092__auto___7949;lt.objs.deploy.request.defaults(cljs.core.clj__GT_js.call(null,new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"proxy","proxy",1120845280),proxy_7950], null)));
} else
{}
if(cljs.core._EQ_.call(null,lt.objs.app.window_number.call(null),0))
{localStorage.fetchedVersion = null;
} else
{}
lt.objs.deploy.check_version.call(null);
return lt.util.js.every.call(null,lt.objs.deploy.version_timeout,lt.objs.deploy.check_version);
});
lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.deploy","check-version","lt.objs.deploy/check-version",3501318508),new cljs.core.Keyword(null,"reaction","reaction",4441361819),lt.objs.deploy.__BEH__check_version,new cljs.core.Keyword(null,"desc","desc",1016984067),"App: Automatically check for updates",new cljs.core.Keyword(null,"triggers","triggers",2516997421),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"init","init",1017141378),null], null), null),new cljs.core.Keyword(null,"type","type",1017479852),new cljs.core.Keyword(null,"user","user",1017503549));
lt.object.tag_behaviors.call(null,new cljs.core.Keyword(null,"app","app",1014001043),new cljs.core.PersistentVector(null, 1, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.Keyword("lt.objs.deploy","check-deploy","lt.objs.deploy/check-deploy",1596260355)], null));
